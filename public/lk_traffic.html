<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–π —Ç—Ä–∞—Ñ–∏–∫ - TeleNova</title>
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <h2>üì± TeleNova <span style="font-size: 14px; color: #999;">- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞</span></h2>
      <div class="navbar-actions">
        <a href="lk_profile.html" class="btn-secondary" style="text-decoration: none;">‚Üê –ù–∞–∑–∞–¥</a>
        <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="card">
      <h2>üìà –°–≤–æ–¥–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h2>
      <div id="summary" class="stats-grid"></div>
    </div>

    <div class="card">
      <h2>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞</h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>üåû –î–Ω—ë–º (MB)</th>
            <th>üåô –ù–æ—á—å—é (MB)</th>
            <th>üìä –í—Å–µ–≥–æ (MB)</th>
            <th>‚òéÔ∏è –ú–∏–Ω—É—Ç—ã</th>
            <th>üí¨ SMS</th>
          </tr>
        </thead>
        <tbody id="traffic-list">
          <tr><td colspan="6" style="text-align: center; color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    if (!user.id || user.type !== 'subscriber') window.location.href = 'login_subscriber.html';

    async function loadTraffic() {
      try {
        const res = await fetch(`${API_URL}/traffic/${user.id}`);
        const traffic = await res.json();
        
        const byDate = {};
        let totalDay = 0, totalNight = 0, totalMin = 0, totalSms = 0;
        
        traffic.forEach(t => {
          if (!byDate[t.date]) {
            byDate[t.date] = { day: 0, night: 0, minutes: 0, sms: 0 };
          }
          if (t.traffic_type === 'day') {
            byDate[t.date].day += t.data_used || 0;
            totalDay += t.data_used || 0;
          } else {
            byDate[t.date].night += t.data_used || 0;
            totalNight += t.data_used || 0;
          }
          byDate[t.date].minutes = (byDate[t.date].minutes || 0) + (t.minutes_used || 0);
          byDate[t.date].sms = (byDate[t.date].sms || 0) + (t.sms_used || 0);
          totalMin += t.minutes_used || 0;
          totalSms += t.sms_used || 0;
        });

        const totalGb = (totalDay + totalNight) / 1024;
        document.getElementById('summary').innerHTML = `
          <div class="stat-item">
            <span class="stat-label">üìä –í—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (–ì–ë)</span>
            <span class="stat-value">${totalGb.toFixed(1)}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">üåû –î–Ω—ë–º (–ì–ë)</span>
            <span class="stat-value">${(totalDay / 1024).toFixed(1)}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">üåô –ù–æ—á—å—é (–ì–ë)</span>
            <span class="stat-value">${(totalNight / 1024).toFixed(1)}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">‚òéÔ∏è –ú–∏–Ω—É—Ç—ã</span>
            <span class="stat-value">${totalMin}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">üí¨ SMS</span>
            <span class="stat-value">${totalSms}</span>
          </div>
        `;

        let tableHtml = '';
        for (const date in byDate) {
          const data = byDate[date];
          tableHtml += `
            <tr>
              <td>${date}</td>
              <td>${(data.day || 0).toFixed(1)}</td>
              <td>${(data.night || 0).toFixed(1)}</td>
              <td>${((data.day || 0) + (data.night || 0)).toFixed(1)}</td>
              <td>${data.minutes || 0}</td>
              <td>${data.sms || 0}</td>
            </tr>
          `;
        }
        
        if (tableHtml === '') {
          tableHtml = '<tr><td colspan="6" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        }
        
        document.getElementById('traffic-list').innerHTML = tableHtml;
      } catch (e) {
        console.error(e);
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    loadTraffic();
  </script>
</body>
</html>
