<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å - TeleNova</title>
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <h2>üì± TeleNova <span style="font-size: 14px; color: #999;">- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</span></h2>
      <div class="navbar-actions">
        <span id="subscriber-name" style="margin-right: 20px; color: #666;"></span>
        <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="subscriber-grid">
      <div class="card">
        <h2>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div id="profile" class="profile-info"></div>
        <a href="lk_traffic.html" class="btn-primary" style="margin-top: 15px; display: inline-block; text-decoration: none;">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞</a>
      </div>

      <div class="card">
        <h2>‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–∞—Ä–∏—Ñ</h2>
        <div id="recommendation" style="padding: 20px; text-align: center; color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <div class="card">
        <h2>üí≥ –í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</h2>
        <div id="tariffs" class="tariffs-grid"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    if (!user.id || user.type !== 'subscriber') window.location.href = 'login_subscriber.html';

    document.getElementById('subscriber-name').textContent = `üë§ ${user.full_name}`;

    async function loadProfile() {
      try {
        const res = await fetch(`${API_URL}/subscribers/${user.id}`);
        const sub = await res.json();
        
        document.getElementById('profile').innerHTML = `
          <div class="profile-item">
            <label>–§–ò–û</label>
            <span>${sub.full_name}</span>
          </div>
          <div class="profile-item">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <span>${sub.phone}</span>
          </div>
          <div class="profile-item">
            <label>–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</label>
            <span>${sub.name}</span>
          </div>
          <div class="profile-item">
            <label>–ú–∏–Ω—É—Ç—ã/–º–µ—Å—è—Ü</label>
            <span>${sub.minutes}</span>
          </div>
          <div class="profile-item">
            <label>–ì–ë/–º–µ—Å—è—Ü</label>
            <span>${sub.data_gb}</span>
          </div>
          <div class="profile-item">
            <label>SMS/–º–µ—Å—è—Ü</label>
            <span>${sub.sms}</span>
          </div>
          <div class="profile-item">
            <label>–¶–µ–Ω–∞/–º–µ—Å—è—Ü</label>
            <span>${sub.price}‚ÇΩ</span>
          </div>
          <div class="profile-item">
            <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
            <span>${new Date(sub.reg_date).toLocaleDateString('ru-RU')}</span>
          </div>
        `;
      } catch (e) {
        console.error(e);
      }
    }

    async function loadRecommendation() {
      try {
        const res = await fetch(`${API_URL}/recommend/${user.id}`);
        const rec = await res.json();
        
        document.getElementById('recommendation').innerHTML = `
          <h3>${rec.recommendedTariff}</h3>
          <p style="margin-top: 10px; font-size: 14px;">${rec.reason}</p>
          <button onclick="selectTariff(${rec.recommendedTariffId}, '${rec.recommendedTariff}')" class="btn-primary" style="margin-top: 15px; width: 100%;">
            –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ
          </button>
        `;
      } catch (e) {
        console.error(e);
      }
    }

    async function selectTariff(tariffId, tarifName) {
      try {
        const res = await fetch(`${API_URL}/subscribe/${user.id}/${tariffId}`, {
          method: 'POST'
        });
        alert(`‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–±—Ä–∞–ª–∏ —Ç–∞—Ä–∏—Ñ "${tarifName}"`);
        loadProfile();
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞—Ä–∏—Ñ–∞');
      }
    }

    async function loadTariffs() {
      try {
        const res = await fetch(`${API_URL}/tariffs`);
        const tariffs = await res.json();
        document.getElementById('tariffs').innerHTML = tariffs.map(t => `
          <div class="tariff-card">
            <h3>${t.name}</h3>
            <div class="tariff-price">${t.price}<span>‚ÇΩ/–º–µ—Å—è—Ü</span></div>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
              ‚òéÔ∏è ${t.minutes} –º–∏–Ω<br>
              üìä ${t.data_gb} –ì–ë<br>
              üí¨ ${t.sms} SMS
            </div>
            <button onclick="selectTariff(${t.id}, '${t.name}')" class="btn-primary" style="margin-top: 15px; width: 100%; padding: 8px;">
              –í—ã–±—Ä–∞—Ç—å
            </button>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    loadProfile();
    loadRecommendation();
    loadTariffs();
  </script>
</body>
</html>
