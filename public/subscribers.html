<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–±–æ–Ω–µ–Ω—Ç—ã - TeleNova</title>
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <h2>üì± TeleNova <span style="font-size: 14px; color: #999;">- –°–ø–∏—Å–æ–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤</span></h2>
      <div class="navbar-actions">
        <a href="dashboard.html" class="btn-secondary" style="text-decoration: none;">‚Üê –ù–∞–∑–∞–¥</a>
        <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="card">
      <h2>–í—Å–µ –∞–±–æ–Ω–µ–Ω—Ç—ã</h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>–§–ò–û</th>
            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th>–¢–∞—Ä–∏—Ñ</th>
            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="subscribers-list">
          <tr><td colspan="5" style="text-align: center; color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>
        <button onclick="closeEditModal()" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modal-sub-id">
        <div class="form-group" style="grid-template-columns: 1fr;">
          <input type="text" id="modal-full-name" placeholder="–§–ò–û" class="input">
          <input type="tel" id="modal-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" class="input">
          <input type="password" id="modal-password" placeholder="–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è—Ç—å)" class="input">
          <select id="modal-tariff" class="input">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeEditModal()" class="btn-secondary" style="width: auto;">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="updateSubscriber()" class="btn-primary" style="width: auto;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="deleteSubscriber()" class="btn-table-delete" style="width: auto;">–£–¥–∞–ª–∏—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–∞</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';

    if (!JSON.parse(localStorage.getItem('user') || '{}').id) window.location.href = 'login_operator.html';

    let currentEditingId = null;

    async function loadSubscribers() {
      try {
        const res = await fetch(`${API_URL}/subscribers`);
        const abonenty = await res.json();
        
        document.getElementById('subscribers-list').innerHTML = abonenty.map(abonent => `
          <tr>
            <td>${abonent.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
            <td>${abonent.phone}</td>
            <td>${abonent.tariff_name || '-'}</td>
            <td>${abonent.reg_date}</td>
            <td>
              <a href="subscriber_card.html?id=${abonent.id}" class="btn-table-edit" style="text-decoration: none;">–û—Ç–∫—Ä—ã—Ç—å</a>
              <button onclick="openEditModal(${abonent.id}, '${abonent.full_name}', '${abonent.phone}', ${abonent.tariff_id}, '${abonent.password}')" class="btn-table-edit">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
              <button onclick="confirmDelete(${abonent.id})" class="btn-table-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    async function loadTariffs() {
      try {
        const res = await fetch(`${API_URL}/tariffs`);
        const tariffs = await res.json();
        const select = document.getElementById('modal-tariff');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</option>';
        tariffs.forEach(tarif => {
          const opt = document.createElement('option');
          opt.value = tarif.id;
          opt.textContent = `${tarif.name} (${tarif.price}‚ÇΩ)`;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
      }
    }

    function openEditModal(id, polnoeImya, nomerTelefona, tariffId, parol) {
      currentEditingId = id;
      document.getElementById('modal-sub-id').value = id;
      document.getElementById('modal-full-name').value = polnoeImya;
      document.getElementById('modal-phone').value = nomerTelefona;
      document.getElementById('modal-tariff').value = tariffId || '';
      document.getElementById('modal-password').value = '';
      document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
      currentEditingId = null;
    }

    async function updateSubscriber() {
      const id = document.getElementById('modal-sub-id').value;
      const polnoeImya = document.getElementById('modal-full-name').value.trim();
      const nomerTelefona = document.getElementById('modal-phone').value.trim();
      const parol = document.getElementById('modal-password').value;
      const tariff_id = document.getElementById('modal-tariff').value;

      if (!polnoeImya || !nomerTelefona || !tariff_id) {
        alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
      }

      try {
        const body = { full_name: polnoeImya, phone: nomerTelefona, tariff_id: parseInt(tariff_id) };
        if (parol) body.password = parol;

        const res = await fetch(`${API_URL}/subscribers/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        
        closeEditModal();
        loadSubscribers();
        alert('‚úÖ –ê–±–æ–Ω–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      } catch (e) {
        alert('‚ùå ' + e.message);
      }
    }

    async function deleteSubscriber() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞?')) return;

      const id = document.getElementById('modal-sub-id').value;

      try {
        const res = await fetch(`${API_URL}/subscribers/${id}`, {
          method: 'DELETE'
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');

        closeEditModal();
        loadSubscribers();
        alert('‚úÖ –ê–±–æ–Ω–µ–Ω—Ç —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      } catch (e) {
        alert('‚ùå ' + e.message);
      }
    }

    function confirmDelete(id) {
      openEditModal(id, '', '', '', '');
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('edit-modal');
      if (event.target === modal) {
        closeEditModal();
      }
    };

    loadSubscribers();
    loadTariffs();
  </script>
</body>
</html>
